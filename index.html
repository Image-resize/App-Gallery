<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>App Gallery</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .animate-fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        /* Hide scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none;  scrollbar-width: none; }
        /* Safe area for bottom nav */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0"
      }
    }
    </script>
</head>
<body class="bg-gray-50 text-gray-900 pb-20">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Search, Menu, User, X, Home, Grid, Gamepad2, 
            Film, BookOpen, Star, Download, LogOut, ChevronRight,
            Share2, ShieldCheck, AlertCircle, Send, CheckCircle,
            Settings, HelpCircle, FileText
        } from 'lucide-react';

        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, updateDoc, increment, addDoc, query, orderBy, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC5RYqD0z0NuSdGVA4PEvHAaxolFmxHlqY",
            authDomain: "app-gallery-sotre.firebaseapp.com",
            projectId: "app-gallery-sotre",
            storageBucket: "app-gallery-sotre.firebasestorage.app",
            messagingSenderId: "70466340292",
            appId: "1:70466340292:web:9b9cc0e5e266816a1bd091",
            measurementId: "G-2JCBTPZW5R"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Splash Screen ---
        const SplashScreen = ({ onFinish }) => {
            const [visible, setVisible] = useState(true);
            useEffect(() => {
                const timer = setTimeout(() => {
                    setVisible(false);
                    setTimeout(onFinish, 500);
                }, 3000);
                return () => clearTimeout(timer);
            }, [onFinish]);

            return (
                <div className={`fixed inset-0 z-[100] bg-white flex items-center justify-center transition-opacity duration-500 ${visible ? 'opacity-100' : 'opacity-0 pointer-events-none'}`}>
                    <div className="w-full h-full relative">
                        <img src="https://res.cloudinary.com/dntvrm1wn/image/upload/v1764593855/1000027246_p8ao5w.jpg" className="w-full h-full object-cover" />
                        <div className="absolute inset-0 bg-black/20 flex flex-col items-center justify-end pb-20">
                            <div className="animate-spin rounded-full h-10 w-10 border-b-2 border-white mb-4"></div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Auth Component ---
        const AuthScreen = ({ authMode, setAuthMode, onAuthSuccess, onSkip }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);
                try {
                    if (authMode === 'login') await signInWithEmailAndPassword(auth, email, password);
                    else await createUserWithEmailAndPassword(auth, email, password);
                    onAuthSuccess();
                } catch (err) {
                    setError(err.message);
                }
                setLoading(false);
            };

            return (
                <div className="min-h-screen pt-20 flex items-center justify-center bg-gray-50 px-4">
                    <div className="max-w-md w-full bg-white rounded-2xl shadow-xl p-8">
                        <h2 className="text-2xl font-bold text-center mb-6">{authMode === 'login' ? 'লগ ইন' : 'অ্যাকাউন্ট খুলুন'}</h2>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <input type="email" required placeholder="ইমেইল" className="w-full px-4 py-2 border rounded-lg" value={email} onChange={(e) => setEmail(e.target.value)} />
                            <input type="password" required placeholder="পাসওয়ার্ড" className="w-full px-4 py-2 border rounded-lg" value={password} onChange={(e) => setPassword(e.target.value)} />
                            {error && <p className="text-red-500 text-sm">{error}</p>}
                            <button type="submit" disabled={loading} className="w-full bg-purple-600 text-white py-2 rounded-lg font-bold">
                                {loading ? 'Loading...' : (authMode === 'login' ? 'লগ ইন' : 'সাইন আপ')}
                            </button>
                        </form>
                        <p className="mt-4 text-center text-sm">
                            {authMode === 'login' ? "অ্যাকাউন্ট নেই? " : "অ্যাকাউন্ট আছে? "}
                            <button onClick={() => setAuthMode(authMode === 'login' ? 'signup' : 'login')} className="text-purple-600 font-bold">এখানে ক্লিক করুন</button>
                        </p>
                        <button onClick={onSkip} className="w-full text-center text-gray-400 text-sm mt-4">স্কিপ করুন</button>
                    </div>
                </div>
            );
        };

        // --- Sidebar (Drawer) Component [UPDATED: Right Side] ---
        const Sidebar = ({ isOpen, onClose, user, setView, setFilter }) => {
            if (!isOpen) return null;

            return (
                <>
                    <div className="fixed inset-0 bg-black/50 z-[60]" onClick={onClose}></div>
                    <div className="fixed inset-y-0 right-0 w-72 bg-white z-[70] shadow-2xl transform transition-transform duration-300 flex flex-col animate-fade-in">
                        
                        {/* Header */}
                        <div className="bg-purple-600 p-6 text-white pt-12">
                            <div className="flex items-center gap-4 mb-2">
                                <div className="w-14 h-14 bg-white/20 rounded-full flex items-center justify-center text-xl font-bold border-2 border-white">
                                    {user?.email?.[0].toUpperCase() || <User />}
                                </div>
                                <div className="overflow-hidden">
                                    <h3 className="font-bold text-lg truncate">{user ? user.email.split('@')[0] : 'Guest User'}</h3>
                                    <p className="text-purple-200 text-xs truncate">{user?.email || 'Login to sync apps'}</p>
                                </div>
                            </div>
                        </div>

                        {/* Menu Items */}
                        <div className="flex-1 overflow-y-auto py-4">
                            <button onClick={() => { setFilter('my_apps'); setView('home'); onClose(); }} className="w-full px-6 py-3 flex items-center gap-4 hover:bg-gray-50 text-gray-700">
                                <Grid size={22} className="text-gray-500" />
                                <span className="font-medium">My Apps & Games</span>
                            </button>
                            <div className="border-t my-2"></div>
                            <button onClick={() => { alert('Notifications feature coming soon!'); onClose(); }} className="w-full px-6 py-3 flex items-center gap-4 hover:bg-gray-50 text-gray-700">
                                <span className="relative">
                                    <ShieldCheck size={22} className="text-gray-500" />
                                </span>
                                <span className="font-medium">Play Protect</span>
                            </button>
                            <button onClick={() => { alert('Settings coming soon!'); onClose(); }} className="w-full px-6 py-3 flex items-center gap-4 hover:bg-gray-50 text-gray-700">
                                <Settings size={22} className="text-gray-500" />
                                <span className="font-medium">Settings</span>
                            </button>
                            <button onClick={() => { alert('Help & Feedback coming soon!'); onClose(); }} className="w-full px-6 py-3 flex items-center gap-4 hover:bg-gray-50 text-gray-700">
                                <HelpCircle size={22} className="text-gray-500" />
                                <span className="font-medium">Help & Feedback</span>
                            </button>
                        </div>

                        {/* Footer */}
                        <div className="p-4 border-t">
                            {user ? (
                                <button onClick={() => { signOut(auth); onClose(); }} className="w-full py-2 px-4 border border-gray-200 rounded-lg flex items-center justify-center gap-2 text-red-600 hover:bg-red-50 font-medium transition-colors">
                                    <LogOut size={18} /> Log Out
                                </button>
                            ) : (
                                <button onClick={() => { setView('auth'); onClose(); }} className="w-full py-2 bg-purple-600 text-white rounded-lg font-bold">
                                    Log In
                                </button>
                            )}
                            <p className="text-center text-xs text-gray-400 mt-4">v1.0.3 • App Gallery</p>
                        </div>
                    </div>
                </>
            );
        };

        // --- Navbar Component [UPDATED: Correct Icons] ---
        const Navbar = ({ user, setView, searchTerm, setSearchTerm, onOpenSidebar }) => (
            <div className="fixed top-0 left-0 right-0 h-16 bg-white shadow-sm z-50 flex items-center px-4 justify-between">
                
                {/* Left Side: Logo */}
                <div className="flex items-center gap-3">
                    <button onClick={() => setView('home')} className="flex items-center gap-2">
                         <img src="https://res.cloudinary.com/dntvrm1wn/image/upload/v1764583350/1000027184_lwzizo.png" className="w-9 h-9 rounded-full" />
                        <span className="text-xl font-bold text-gray-800 hidden sm:block">App Gallery</span>
                    </button>
                </div>
                
                {/* Center: Search */}
                <div className="flex-1 max-w-md mx-4">
                    <div className="relative">
                        <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-4 h-4" />
                        <input 
                            type="text" placeholder="Search apps..." 
                            className="w-full bg-gray-100 border-none rounded-lg py-2.5 pl-10 pr-3 text-sm focus:ring-2 focus:ring-purple-500 outline-none transition-all shadow-inner"
                            value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)}
                        />
                    </div>
                </div>
                
                {/* Right Side: User Avatar / Menu */}
                <div className="flex items-center">
                    <button onClick={onOpenSidebar} className="rounded-full hover:bg-gray-100 transition-colors ml-1">
                        {user ? (
                             <div className="relative w-9 h-9 rounded-full bg-purple-600 text-white flex items-center justify-center font-bold text-lg border border-purple-200 shadow-sm">
                                {user.email.charAt(0).toUpperCase()}
                                <div className="absolute -bottom-1 -right-1 bg-white rounded-full p-0.5 border border-gray-200 shadow-sm">
                                    <Menu size={10} className="text-gray-600" />
                                </div>
                             </div>
                        ) : (
                            <div className="p-2">
                                <Menu className="w-7 h-7 text-gray-600" />
                            </div>
                        )}
                    </button>
                </div>
            </div>
        );

        // --- Bottom Navigation ---
        const BottomNav = ({ currentFilter, setFilter, setView }) => {
            const navItems = [
                { id: 'all', icon: Home, label: 'Home' },
                { id: 'game', icon: Gamepad2, label: 'Games' },
                { id: 'app', icon: Grid, label: 'Apps' },
            ];

            return (
                <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 pb-safe z-40">
                    <div className="flex justify-around items-center h-16">
                        {navItems.map((item) => {
                            const isActive = currentFilter === item.id;
                            return (
                                <button 
                                    key={item.id}
                                    onClick={() => {
                                        setFilter(item.id);
                                        setView('home');
                                    }}
                                    className={`flex flex-col items-center justify-center w-full h-full space-y-1 ${isActive ? 'text-purple-600' : 'text-gray-500'}`}
                                >
                                    <item.icon size={24} strokeWidth={isActive ? 2.5 : 2} />
                                    <span className="text-[10px] font-medium">{item.label}</span>
                                </button>
                            )
                        })}
                    </div>
                </div>
            );
        };

        // --- Featured Card Component ---
        const FeaturedCard = ({ app, onClick }) => (
            <div onClick={onClick} className="relative w-full h-56 sm:h-72 rounded-3xl overflow-hidden cursor-pointer shadow-lg group mb-8 transition-transform transform hover:scale-[1.01]">
                <div className="absolute inset-0 bg-gradient-to-r from-purple-900 to-purple-600">
                    {app.screenshotUrls && app.screenshotUrls[0] && (
                        <img src={app.screenshotUrls[0]} className="w-full h-full object-cover opacity-60 mix-blend-overlay" />
                    )}
                </div>
                <div className="absolute inset-0 bg-gradient-to-t from-black/90 via-black/40 to-transparent"></div>
                <div className="absolute bottom-0 left-0 p-6 w-full text-white">
                    <div className="flex items-center gap-4">
                        <img src={app.iconUrl} className="w-16 h-16 rounded-xl shadow-lg border-2 border-white/20 bg-white object-cover" />
                        <div className="flex-1">
                            <h2 className="text-2xl font-bold mb-1 leading-tight">{app.name}</h2>
                            <p className="text-white/80 text-xs mb-3 line-clamp-2">{app.description}</p>
                            <button className="bg-white text-purple-900 px-5 py-2 rounded-full text-xs font-bold hover:bg-purple-50 transition-colors shadow-lg">
                                বিস্তারিত দেখুন
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        );

        // --- App Details Component [UPDATED: Live Rating Fix] ---
        const AppDetailView = ({ app: initialApp, setView, user, setAuthMode }) => {
            const [app, setApp] = useState(initialApp); // Use local state for live updates
            const [reviews, setReviews] = useState([]);
            const [newReview, setNewReview] = useState('');
            const [rating, setRating] = useState(0);
            const [downloading, setDownloading] = useState(false);
            const [downloadProgress, setDownloadProgress] = useState(0);
            const [copied, setCopied] = useState(false);

            // Listen for Real-time App Updates (Rating)
            useEffect(() => {
                if(!initialApp) return;
                const unsubApp = onSnapshot(doc(db, "apps", initialApp.id), (doc) => {
                     if (doc.exists()) {
                         setApp({ id: doc.id, ...doc.data() });
                     }
                });

                const q = query(collection(db, `apps/${initialApp.id}/reviews`), orderBy("createdAt", "desc"));
                const unsubReviews = onSnapshot(q, (snapshot) => {
                    setReviews(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
                
                return () => { unsubApp(); unsubReviews(); };
            }, [initialApp]);

            const handleDownload = async () => {
                if (!app.downloadUrl) return alert("Link broken");
                setDownloading(true);
                setDownloadProgress(10); 
                try {
                    const appRef = doc(db, "apps", app.id);
                    await updateDoc(appRef, { downloadCount: increment(1) });
                    
                    setDownloadProgress(30);
                    await new Promise(r => setTimeout(r, 1500));
                    setDownloadProgress(70);

                    try { const response = await fetch(app.downloadUrl, { mode: 'no-cors' }); } catch (e) {}

                    setDownloadProgress(100);
                    
                    setTimeout(() => {
                        const link = document.createElement('a');
                        link.href = app.downloadUrl;
                        link.target = '_blank'; 
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        setDownloading(false);
                        setDownloadProgress(0);
                    }, 500);

                } catch (err) {
                    window.open(app.downloadUrl, '_blank');
                    setDownloading(false);
                    setDownloadProgress(0);
                }
            };

            const submitReview = async (e) => {
                e.preventDefault();
                if (!user) {
                    alert("রিভিউ দেওয়ার জন্য লগইন করুন");
                    setAuthMode('login');
                    setView('auth');
                    return;
                }
                if (rating === 0) return alert("দয়া করে রেটিং দিন");

                try {
                    // 1. Add Review
                    await addDoc(collection(db, `apps/${app.id}/reviews`), {
                        text: newReview,
                        rating: rating,
                        user: user.email.split('@')[0],
                        createdAt: new Date()
                    });

                    // 2. Calculate New Average
                    const appRef = doc(db, "apps", app.id);
                    // Use the LATEST data from 'app' state (which is synced via snapshot)
                    const currentRating = app.rating || 0;
                    const currentCount = app.ratingCount || 0;
                    
                    const newCount = currentCount + 1;
                    const newRating = ((currentRating * currentCount) + rating) / newCount;

                    // 3. Update Doc (Snapshot listener will auto-update UI)
                    await updateDoc(appRef, { 
                        rating: parseFloat(newRating.toFixed(1)), 
                        ratingCount: newCount 
                    });

                    setNewReview('');
                    setRating(0);
                } catch (error) { 
                    console.error("Error", error); 
                    alert("Error submitting review");
                }
            };

            const handleShare = () => {
                const link = `${window.location.origin}${window.location.pathname}?appId=${app.id}`;
                navigator.clipboard.writeText(link).then(() => {
                    setCopied(true);
                    setTimeout(() => setCopied(false), 2000);
                });
            };

            if (!app) return null;

            return (
                <div className="max-w-4xl mx-auto pt-20 px-4 pb-24 animate-fade-in relative">
                    <button onClick={() => setView('home')} className="mb-4 flex items-center text-gray-600 font-medium hover:text-purple-600 transition-colors">
                        <ChevronRight className="w-5 h-5 rotate-180" /> ফিরে যান
                    </button>
                    
                    <div className="flex flex-col sm:flex-row gap-6 mb-8">
                        <div className="w-32 h-32 rounded-3xl overflow-hidden shadow-xl border border-gray-100 bg-white shrink-0">
                            <img src={app.iconUrl} className="w-full h-full object-cover" />
                        </div>
                        <div className="flex-1 pt-2 text-left">
                            <h1 className="text-3xl font-bold text-gray-900">{app.name}</h1>
                            <p className="text-purple-600 font-medium mb-4">{app.developer}</p>
                            <div className="flex items-center justify-start gap-6 mb-6 text-sm">
                                <div className="text-center pr-4 border-r">
                                    <div className="font-bold flex justify-center items-center gap-1">
                                        {app.rating ? app.rating.toFixed(1) : '0.0'} 
                                        <Star size={12} fill="orange" className="text-orange-400"/>
                                    </div>
                                    <div className="text-gray-500 text-xs">{app.ratingCount || 0} reviews</div>
                                </div>
                                <div className="text-center px-4 border-r">
                                    <div className="font-bold">{app.size}</div>
                                    <div className="text-gray-500 text-xs">Size</div>
                                </div>
                                <div className="text-center px-4">
                                    <div className="font-bold">{app.downloadCount || 0}</div>
                                    <div className="text-gray-500 text-xs">Downloads</div>
                                </div>
                            </div>
                            <div className="flex gap-3">
                                <button 
                                    onClick={handleDownload} 
                                    disabled={downloading} 
                                    className={`flex-1 relative overflow-hidden text-white px-6 py-3 rounded-full font-bold shadow-lg flex items-center justify-center gap-2 transition-all ${downloading ? 'bg-gray-800' : 'bg-purple-600 hover:bg-purple-700'}`}
                                >
                                    {downloading ? (
                                        <>
                                            <div className="absolute inset-0 bg-purple-600 transition-all duration-300" style={{width: `${downloadProgress}%`, opacity: 0.3}}></div>
                                            <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                                            <span className="z-10 text-sm">প্রস্তুত হচ্ছে... {downloadProgress}%</span>
                                        </>
                                    ) : (
                                        <><Download size={20} /> ডাউনলোড করুন</>
                                    )}
                                </button>
                                <button onClick={handleShare} className="p-3 border rounded-full hover:bg-gray-50 text-gray-600 relative">
                                    {copied ? <CheckCircle size={20} className="text-green-600" /> : <Share2 size={20} />}
                                    {copied && <span className="absolute -top-8 left-1/2 -translate-x-1/2 bg-black text-white text-xs px-2 py-1 rounded w-max">Link Copied!</span>}
                                </button>
                            </div>
                        </div>
                    </div>
                    {app.screenshotUrls?.length > 0 && (
                        <div className="mb-8">
                            <h3 className="font-bold mb-3">স্ক্রিনশট</h3>
                            <div className="flex gap-4 overflow-x-auto pb-4 no-scrollbar snap-x">
                                {app.screenshotUrls.map((url, i) => <img key={i} src={url} className="h-64 rounded-xl shadow-md snap-center border border-gray-100" />)}
                            </div>
                        </div>
                    )}
                    <div className="mb-8">
                        <h3 className="font-bold mb-2">বিবরণ</h3>
                        <p className="text-gray-600 whitespace-pre-line text-sm leading-relaxed">{app.description}</p>
                    </div>
                    <div className="bg-white rounded-2xl p-6 shadow-sm border">
                        <h3 className="font-bold mb-4">রিভিউ ও রেটিং ({reviews.length})</h3>
                        <div className="mb-6">
                            {!user ? (
                                <div className="bg-gray-50 p-4 rounded-xl text-center text-sm border border-dashed border-gray-300">
                                    রিভিউ দিতে <button onClick={()=>{setAuthMode('login'); setView('auth');}} className="text-purple-600 font-bold underline">লগ ইন</button> করুন
                                </div>
                            ) : (
                                <form onSubmit={submitReview} className="space-y-3 bg-gray-50 p-4 rounded-xl">
                                    <p className="text-xs font-bold text-gray-500">আপনার মতামত দিন</p>
                                    <div className="flex gap-2">
                                        {[1,2,3,4,5].map(s => (
                                            <Star key={s} size={28} className={`cursor-pointer transition-colors ${rating >= s ? 'fill-yellow-400 text-yellow-400' : 'text-gray-300 hover:text-yellow-200'}`} onClick={() => setRating(s)} />
                                        ))}
                                    </div>
                                    <textarea value={newReview} onChange={(e) => setNewReview(e.target.value)} placeholder="এই অ্যাপটি আপনার কেমন লেগেছে?" className="w-full border rounded-xl p-3 focus:ring-2 focus:ring-purple-500 outline-none text-sm bg-white" required rows="3"></textarea>
                                    <div className="flex justify-end">
                                        <button type="submit" className="bg-purple-600 text-white px-6 py-2 rounded-lg text-sm font-bold flex items-center gap-2 hover:bg-purple-700">
                                            <Send size={14} /> পোস্ট করুন
                                        </button>
                                    </div>
                                </form>
                            )}
                        </div>
                        <div className="space-y-6">
                            {reviews.map(rev => (
                                <div key={rev.id} className="border-b pb-4 last:border-0 last:pb-0">
                                    <div className="flex items-center gap-3 mb-2">
                                        <div className="w-8 h-8 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center font-bold text-xs">
                                            {rev.user.charAt(0).toUpperCase()}
                                        </div>
                                        <div>
                                            <span className="font-bold text-sm block">{rev.user}</span>
                                            <div className="flex items-center text-xs text-yellow-500 gap-0.5">
                                                {Array.from({length: 5}).map((_, i) => (
                                                    <Star key={i} size={10} className={i < rev.rating ? "fill-current" : "text-gray-300"} />
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                    <p className="text-gray-600 text-sm ml-11">{rev.text}</p>
                                </div>
                            ))}
                            {reviews.length === 0 && <p className="text-center text-gray-400 text-sm py-4">এখনো কোনো রিভিউ নেই। আপনিই প্রথম রিভিউ দিন!</p>}
                        </div>
                    </div>
                </div>
            );
        };

        function MainApp() {
            const [showSplash, setShowSplash] = useState(true);
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [view, setView] = useState('home');
            const [selectedApp, setSelectedApp] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [apps, setApps] = useState([]);
            const [authMode, setAuthMode] = useState('login');
            const [filter, setFilter] = useState('all');
            const [isSidebarOpen, setSidebarOpen] = useState(false);

            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const appId = params.get('appId');
                if (appId) {
                    const fetchSpecificApp = async () => {
                        const docRef = doc(db, "apps", appId);
                        const docSnap = await getDoc(docRef);
                        if (docSnap.exists()) {
                            setSelectedApp({ id: docSnap.id, ...docSnap.data() });
                            setView('details');
                            window.history.replaceState({}, document.title, window.location.pathname);
                        }
                    }
                    fetchSpecificApp();
                }
                const unsubscribe = onAuthStateChanged(auth, setUser);
                const q = query(collection(db, "apps"), orderBy("uploadedAt", "desc"));
                const unsubApps = onSnapshot(q, (snapshot) => {
                    setApps(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    setLoading(false);
                });
                return () => { unsubscribe(); unsubApps(); };
            }, []);

            const filteredApps = apps.filter(app => {
                const matchesSearch = app.name.toLowerCase().includes(searchTerm.toLowerCase());
                if (!matchesSearch) return false;
                if (filter === 'all') return true;
                if (filter === 'my_apps') return false; 
                return app.category?.toLowerCase().includes(filter) || app.type === filter;
            });

            const featuredApp = apps.length > 0 ? apps[0] : null;

            if (showSplash) return <SplashScreen onFinish={() => setShowSplash(false)} />;
            if (loading) return <div className="min-h-screen flex items-center justify-center"><div className="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"></div></div>;
            if (view === 'auth') return <AuthScreen authMode={authMode} setAuthMode={setAuthMode} onAuthSuccess={() => setView('home')} onSkip={() => setView('home')} />;
            if (view === 'details') return <AppDetailView app={selectedApp} setView={setView} user={user} setAuthMode={setAuthMode} />;

            return (
                <div className="min-h-screen bg-gray-50 font-sans text-gray-900">
                    <Sidebar 
                        isOpen={isSidebarOpen} 
                        onClose={() => setSidebarOpen(false)} 
                        user={user}
                        setView={setView}
                        setFilter={setFilter}
                    />
                    
                    <Navbar 
                        user={user} 
                        setView={setView} 
                        searchTerm={searchTerm} 
                        setSearchTerm={setSearchTerm} 
                        onOpenSidebar={() => setSidebarOpen(true)}
                    />
                    
                    <main className="pt-16 pb-8 px-4 max-w-7xl mx-auto min-h-screen">
                        
                        {/* FEATURED SECTION */}
                        {filter === 'all' && !searchTerm && featuredApp && (
                             <FeaturedCard app={featuredApp} onClick={() => { setSelectedApp(featuredApp); setView('details'); }} />
                        )}

                        <div className="flex items-center justify-between mb-4 mt-2">
                            <h2 className="text-xl font-bold text-gray-800 capitalize">
                                {filter === 'all' ? (searchTerm ? 'Search Results' : 'All Apps') : (filter === 'game' ? 'Games' : (filter === 'my_apps' ? 'My Library' : 'Apps'))}
                            </h2>
                        </div>
                        
                        {filter === 'my_apps' ? (
                            <div className="text-center py-20 text-gray-500">
                                <Download className="mx-auto mb-2 opacity-50" size={40} />
                                <p>আপনার ডাউনলোড করা অ্যাপস এখানে দেখাবে</p>
                                <p className="text-xs text-gray-400 mt-2">(Coming Soon: Local Storage Tracking)</p>
                            </div>
                        ) : filteredApps.length > 0 ? (
                            <div className="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-4">
                                {filteredApps.map(app => (
                                    <div key={app.id} onClick={() => { setSelectedApp(app); setView('details'); }} className="group flex flex-col cursor-pointer p-3 rounded-2xl bg-white border border-gray-100 shadow-sm hover:shadow-md transition-all hover:-translate-y-1">
                                        <div className="w-full aspect-square rounded-2xl overflow-hidden mb-3 bg-gray-100 relative">
                                            <img src={app.iconUrl} alt={app.name} className="w-full h-full object-cover" />
                                        </div>
                                        <h3 className="text-sm font-semibold text-gray-800 line-clamp-1">{app.name}</h3>
                                        <div className="flex items-center justify-between mt-1">
                                            <p className="text-xs text-gray-500">{app.size}</p>
                                            <div className="flex items-center gap-1 text-[10px] text-gray-600 bg-gray-100 px-1.5 py-0.5 rounded">
                                                <Star size={8} className="fill-orange-400 text-orange-400" /> {app.rating ? app.rating.toFixed(1) : '0.0'}
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <div className="text-center py-20">
                                <AlertCircle className="mx-auto h-12 w-12 text-gray-300 mb-3" />
                                <p className="text-gray-500">কোনো অ্যাপ পাওয়া যায়নি</p>
                            </div>
                        )}
                    </main>

                    <BottomNav currentFilter={filter} setFilter={setFilter} setView={setView} />
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<MainApp />);
    </script>
</body>
</html>